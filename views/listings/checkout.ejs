<% layout("/layouts/boilerplate") %>

    <div class="row mt-3">
        <div class="col-6 offset-3">
            <h3>Complete Your Booking</h3>
            <hr>
            <h4>Booking:
                <%= listing.title %>
            </h4>
            <p>Total Amount: **&#8377;
                <%= (priceInPaise / 100).toLocaleString("en-IN") %>**</p>

            <form id="payment-form">
                <div id="checkout-form">
                </div>

                <button class="btn btn-success mt-4 mb-3" id="submit">
                <span id="button-text">Proceed to Pay</span>
                <span id="spinner" class="spinner-border spinner-border-sm hidden" role="status" aria-hidden="true"></span>
            </button>
            </form>

            <div id="payment-message" class="alert alert-danger hidden" role="alert"></div>
        </div>
    </div>

    <script src="https://js.stripe.com/v3/"></script>
    <script>
        // 1. Initialize Stripe
        const stripe = Stripe("<%= process.env.STRIPE_PUBLIC_KEY %>");
        const clientSecret = "<%= clientSecret %>";

        let elements;
        const form = document.querySelector("#payment-form");

        // 2. Initialize and Mount Elements
        const initialize = () => {
            elements = stripe.elements({
                clientSecret
            });

            const paymentElementOptions = {
                layout: "tabs",
            };

            const paymentElement = elements.create("payment", paymentElementOptions);
            paymentElement.mount("#checkout-form");

            // Attach the submit handler to the form element
            form.addEventListener("submit", handleSubmit);
        };

        // 3. Handle Form Submission
        const handleSubmit = async(e) => {
            e.preventDefault();
            setLoading(true);

            const {
                error
            } = await stripe.confirmPayment({
                elements,
                confirmParams: {
                    // Return to the listing page after successful payment
                    return_url: window.location.origin + "/listings/<%= listing._id %>",
                },
            });

            if (error.type === "card_error" || error.type === "validation_error") {
                showMessage(error.message);
            } else if (error) {
                // Handle generic errors from stripe API call
                showMessage(error.message || "An unexpected error occurred.");
            }

            setLoading(false);
        };

        // Helper functions for UI feedback
        const showMessage = (messageText) => {
            const messageContainer = document.querySelector("#payment-message");
            messageContainer.classList.remove("hidden", "alert-success");
            messageContainer.classList.add("alert-danger"); // Use danger for errors
            messageContainer.textContent = messageText;
        };

        const setLoading = (isLoading) => {
            const submitButton = document.querySelector("#submit");
            const spinner = document.querySelector("#spinner");
            const buttonText = document.querySelector("#button-text");

            if (isLoading) {
                submitButton.disabled = true;
                spinner.classList.remove("hidden");
                buttonText.classList.add("hidden");
            } else {
                submitButton.disabled = false;
                spinner.classList.add("hidden");
                buttonText.classList.remove("hidden");
            }
        };

        // Initial call to set up the form and elements
        initialize();

        // Add CSS class definition for 'hidden'
        const style = document.createElement('style');
        style.innerHTML = '.hidden { display: none !important; }';
        document.head.appendChild(style);
    </script>